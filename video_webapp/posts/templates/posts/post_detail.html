{% extends "posts/base.html" %}
{% load crispy_forms_tags %}
{% block video %}
<div class="row">
  <!--Spacing-->
  <div class="col-md-1"></div>
  <!--Actual content-->
  <div class="col-md-8">
    <!--Video-->
    {% if object.video %}
      <video name="{{ object.video }}" controls width='100%'>
        <source src="{{ object.video.url }}"></source>
      </video>
    {% endif %}
    <!--Video Title-->
    <h2 class="article-title">{{ object.title }}</h2>
    <!--Video Description-->
    <article class="media content-section">
      <img class="rounded-circle article-img" src="{{ object.author.profile.image.url }}">
      <div class="media-body">
        <div class="article-metadata">
          <a class="mr-2" href="{% url 'user-posts' object.author.username %}">{{ object.author }}</a>
          <small class="text-muted">{{ object.date_posted|date:"l, F dS, Y, P T" }}</small>
        </div>
        <p class="article-content break-words">{{ object.content }}</p>
        <!-- Update and Delete buttons -->
        {% if object.author == user %}
        <div>
          <a class="btn-secondary btn-sm mt-1 mb-1" href="{% url 'post-update' object.id %}">Update Post</a>
          <a class="btn-danger btn-sm mt-1 mb-1" href="{% url 'post-delete' object.id %}">Delete Post</a>
        </div>
        {% endif %}
      </div>
    </article>
    <!--Comment Section-->
    <!--Title-->
    <div class="row">
      <div class="col-md-12">
          <legend class="border-bottom mb-4">Comments ({{ page_obj.paginator.count }}) </legend> 
      </div>
    </div>
    <!--New Comment-->
      <!--New Comment Button-->
      <div id='hide-toggle-button1'>
        <button class="btn btn-outline-info" onclick="hideToggle()">New Comment</button>
      </div>
      <!--New Comment Form, initially hidden-->
      <div class="row" id='hide-toggle-button2' style="display:none">
        <!--Spacing-->
        <div class="row">
          <div class="col-md-1"></div>
          <div class="col-md-8">
            <form method="post" class='new-comment-form'>
              {% csrf_token %}
              {{ comment_form|crispy }}
              <button class="btn btn-outline-success" type="submit">Add New Comment</button>
              <button class="btn btn-outline-dark" onclick="hideToggle()">Cancel</button>
            </form>
          </div>
        </div>
      </div>
    <!--Spacing-->
    <div class="row">
      <div class="col-md-12">
        <legend class="mb-4"></legend> 
      </div>
    </div>
    <div id="comment-list" data-url="{{ request.build_absolute_uri|safe }}">
      <!--Comments-->
      {% include 'posts/comment_page.html' %}
      <!--End Comments-->
    </div>  
  </div>
</div>
{% endblock video %}
{% block javascript %}
  <!--Scripts-->
  <!--Toggle for new comment-->
  <script type="text/javascript">
    function hideToggle() {
      var x = document.getElementById("hide-toggle-button1");
      if (x) {
        if (x.style.display === "none") {
          x.style.display = "block";
        } else {
          x.style.display = "none";
        }
      }
      x = document.getElementById("hide-toggle-button2");
      if (x) {
        if (x.style.display === "none") {
          x.style.display = "block";
        } else {
          x.style.display = "none";
        }
      }
    }
    $(function(){
      var $newCommentForm = $('.new-comment-form')
      $newCommentForm.submit(function(event){
        console.log("Form Submitted")
        event.preventDefault()
        var $formData = $(this).serialize()
        var $thisURL = window.location.href // Data is sent to current page
        hideToggle() // Hide the new comment button
        // Post Comment
        $.ajax({
          method: "POST",
          url: $thisURL,
          data: $formData,
          success: handleFormSuccess,
          error: handleFormError,
        })
        // Refresh Comments
        $.ajax({
          method: 'GET',
          url: $newCommentForm.attr('data-url'),
          dataType : 'json',
          data: {},
          success: function(data){
            console.log(data)
            $('#comment-list').replaceWith($('#comment-list',data));
          },
          error: function(error){
            console.log(error);
            console.log("comment list error");
          }
        });
      })

      // var refreshStream = function(){
      //   var $thisURL = window.location.href // Data is sent to current page
      //   $.ajax({
      //     method: 'GET',
      //     url: $thisURL,
      //     data: {},
      //     success: function(data){
      //       $('#comment-list').replaceWith($('#comment-list',data));
      //     },
      //     error: function(error){
      //       console.log(error);
      //       console.log("error");
      //     }
      //   });
      // }

      // setInterval(function(){
      //     refreshStream();
      // },5 * 1000);

      function handleFormSuccess(data, textStatus, jqXHR){
        // console.log(data)
        // console.log(textStatus)
        // console.log(jqXHR)
        $newCommentForm[0].reset(); // reset form data
      }

      function handleFormError(jqXHR, textStatus, errorThrown){
        console.log(jqXHR)
        console.log(textStatus)
        console.log(errorThrown)
      }
    })
  </script>
{% endblock javascript %}